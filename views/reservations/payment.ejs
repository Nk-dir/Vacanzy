<%- layout("layouts/boilerplate") %>

<div class="row mt-3">
    <div class="col-md-8 offset-md-2">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Complete Your Booking Payment</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Booking Summary -->
                    <div class="col-md-8">
                        <div class="booking-summary">
                            <h4><%= listing.title %></h4>
                            <p class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> <%= listing.location %>, <%= listing.country %>
                            </p>
                            
                            <div class="booking-details mt-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Check-in:</strong><br>
                                        <span class="text-muted"><%= new Date(checkIn).toLocaleDateString() %></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Check-out:</strong><br>
                                        <span class="text-muted"><%= new Date(checkOut).toLocaleDateString() %></span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <strong>Duration:</strong> <%= numberOfNights %> nights
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Breakdown -->
                    <div class="col-md-4">
                        <div class="price-breakdown bg-light p-3 rounded">
                            <h5>Price Details</h5>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span>₹<%= listing.price.toLocaleString("en-IN") %> × <%= numberOfNights %> nights</span>
                                <span>₹<%= subtotal.toLocaleString("en-IN") %></span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span>Service fee</span>
                                <span>₹<%= serviceFee.toLocaleString("en-IN") %></span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span>Taxes</span>
                                <span>₹<%= tax.toLocaleString("en-IN") %></span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold fs-5">
                                <span>Total</span>
                                <span>₹<%= totalPrice.toLocaleString("en-IN") %></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Button -->
                <div class="text-center mt-4">
                    <button id="payNowBtn" class="btn btn-success btn-lg px-5">
                        <i class="fas fa-credit-card me-2"></i>
                        Pay ₹<%= totalPrice.toLocaleString("en-IN") %>
                    </button>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Your payment is secured by Razorpay
                        </small>
                    </div>
                </div>
                
                <!-- Cancel Button -->
                <div class="text-center mt-3">
                    <a href="/listings/<%= listing._id %>" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Cancel & Go Back
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Processing Payment...</h5>
                <p class="text-muted mb-0">Please don't refresh the page</p>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="text/javascript">
    emailjs.init('<%= process.env.EMAILJS_PUBLIC_KEY %>');
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const payNowBtn = document.getElementById('payNowBtn');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    payNowBtn.addEventListener('click', function() {
        // Show loading modal
        loadingModal.show();
        
        // Create payment order
        fetch(`/listings/<%= listing._id %>/reservations/payment/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                checkIn: '<%= checkIn %>',
                checkOut: '<%= checkOut %>'
            })
        })
        .then(response => {
            console.log('Payment order response status:', response.status);
            return response.json();
        })
        .then(data => {
            loadingModal.hide();
            console.log('Payment order response data:', data);
            
            if (data.success) {
                // Initialize Razorpay payment
                console.log('Razorpay Key ID:', '<%= razorpayKeyId %>');
                const options = {
                    key: '<%= razorpayKeyId %>',
                    amount: data.order.amount,
                    currency: data.order.currency,
                    name: 'Vacanzy',
                    description: 'Booking for ' + data.listing.title,
                    order_id: data.order.id,
                    prefill: {
                        name: data.user.name,
                        email: data.user.email,
                        contact: data.user.phone
                    },
                    theme: {
                        color: '#667eea'
                    },
                    handler: function(response) {
                        // Payment successful, verify payment
                        verifyPayment(response, data.reservation.id);
                    },
                    modal: {
                        ondismiss: function() {
                            // Payment cancelled
                            handlePaymentFailure(data.reservation.id, 'Payment cancelled by user');
                        }
                    }
                };
                
                const rzp = new Razorpay(options);
                rzp.open();
                
                rzp.on('payment.failed', function(response) {
                    console.log('Payment failed event:', response);
                    handlePaymentFailure(data.reservation.id, response.error.description);
                });
                
            } else {
                console.error('Payment order creation failed:', data);
                alert('Error creating payment order: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            loadingModal.hide();
            console.error('Error:', error);
            alert('Error processing payment. Please try again.');
        });
    });
    
    function verifyPayment(response, reservationId) {
        loadingModal.show();
        console.log('Starting payment verification...', response);
        
        fetch('/payment/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                reservation_id: reservationId
            })
        })
        .then(response => {
            console.log('Payment verification response status:', response.status);
            return response.json();
        })
        .then(data => {
            loadingModal.hide();
            console.log('Payment verification response data:', data);
            
            if (data.success) {
                // Send confirmation email using EmailJS if email data is provided
                if (data.emailData && typeof emailjs !== 'undefined') {
                    console.log('Sending confirmation email...', data.emailData);
                    
                    emailjs.send('<%= process.env.EMAILJS_SERVICE_ID %>', '<%= process.env.EMAILJS_TEMPLATE_ID %>', data.emailData)
                        .then(function(response) {
                            console.log('Confirmation email sent successfully:', response);
                            // Redirect to confirmation page after email is sent
                            window.location.href = `/reservations/${reservationId}/confirmation?emailSent=true`;
                        })
                        .catch(function(error) {
                            console.error('Failed to send confirmation email:', error);
                            // Still redirect even if email fails
                            window.location.href = `/reservations/${reservationId}/confirmation?emailSent=false`;
                        });
                } else {
                    console.log('No email data or EmailJS not available');
                    // Redirect to confirmation page
                    window.location.href = `/reservations/${reservationId}/confirmation`;
                }
            } else {
                console.error('Payment verification failed:', data);
                alert('Payment verification failed: ' + data.message);
            }
        })
        .catch(error => {
            loadingModal.hide();
            console.error('Error:', error);
            alert('Error verifying payment. Please contact support.');
        });
    }
    
    function handlePaymentFailure(reservationId, errorDescription) {
        fetch('/payment/failure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                reservation_id: reservationId,
                error_description: errorDescription
            })
        })
        .then(() => {
            alert('Payment failed: ' + errorDescription);
            window.location.href = '/listings/<%= listing._id %>';
        })
        .catch(error => {
            console.error('Error handling payment failure:', error);
        });
    }
});
</script>